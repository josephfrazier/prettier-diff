#!/usr/bin/env node

const fs = require('fs');
const child_process = require('child_process');
const prettierDiff = require('../');
const tempfile = require('tempfile');
const shell = require('shell-escape-tag').default;
const escapeStringRegexp = require('escape-string-regexp');

const [fromPath, toPath] = process.argv.slice(2);

const fromContent = fs.readFileSync(fromPath).toString();
const toContent = fs.readFileSync(toPath).toString();

const { fromPretty, toPretty } = prettierDiff({
  fromPath,
  toPath,
  fromContent,
  toContent,
});

const [fromTmp, toTmp] = [tempfile(), tempfile()];

fs.writeFileSync(fromTmp, fromPretty);
fs.writeFileSync(toTmp, toPretty);

// If process.env.BASE is present, we're running as a git difftool,
// so use the correct paths. See https://git-scm.com/docs/git-difftool
const fromPathClean = process.env.BASE || fromPath;
const toPathClean = process.env.BASE || toPath;

// TODO dedupe/simplify sed stuff below. Maybe even capture git-diff output and process it in JS instead?
const command = shell`\
  git diff --color --no-index ${fromTmp} ${toTmp} \
  | ${shell.preserve(`sed -e 's#--- a${escapeStringRegexp(fromTmp)}#--- a/${escapeStringRegexp(fromPathClean)}#'`)} \
  | ${shell.preserve(`sed -e 's#\+\+\+ b${escapeStringRegexp(toTmp)}#\+\+\+ a/${escapeStringRegexp(toPathClean)}#'`)} \
  | ${__dirname}/../node_modules/.bin/diff-so-fancy \
  | less --tabs=2 -RFX
`;
try {
  child_process.execSync(command, {
    stdio: 'inherit', // https://stackoverflow.com/questions/30134236/use-child-process-execsync-but-keep-output-in-console#comment61502598_31104898
  });
} catch (err) {
  process.exitCode = err.status;
}

fs.unlinkSync(fromTmp);
fs.unlinkSync(toTmp);
