#!/usr/bin/env node

const yargs = require('yargs');
const fs = require('fs');
const child_process = require('child_process');
const prettierDiff = require('../');
const tempfile = require('tempfile');
const shell = require('shell-escape-tag').default;

const [fromPath, toPath] = yargs
  .help()
  .version()
  .usage('Usage: $0 <path> <path>')
  .example('$0 test/js.js test/js.js.uglified')
  .example('$0 test/json.json test/json.json.uglified')
  .example('git difftool --extcmd=$0')
  .demandCommand(
    2,
    2,
    'Not enough arguments: got $0, need exactly 2',
    'Too many arguments: got $0, need exactly 2'
  ).argv._;

const fromContent = fs.readFileSync(fromPath).toString();
const toContent = fs.readFileSync(toPath).toString();

const { fromPretty, toPretty } = prettierDiff({
  fromPath,
  toPath,
  fromContent,
  toContent,
});

const [fromTmp, toTmp] = [tempfile(), tempfile()];

fs.writeFileSync(fromTmp, fromPretty);
fs.writeFileSync(toTmp, toPretty);

// If process.env.BASE is present, we're running as a git difftool,
// so use the correct paths. See https://git-scm.com/docs/git-difftool
const fromPathClean = process.env.BASE || fromPath;
const toPathClean = process.env.BASE || toPath;

try {
  const diffOutput = child_process
    .execSync(shell`git diff --color --no-index ${fromTmp} ${toTmp} | cat`)
    .toString()
    .replace(`--- a${fromTmp}`, `--- a/${fromPathClean}`)
    .replace(`+++ b${toTmp}`, `+++ a/${toPathClean}`);

  const command = shell`\
    ${__dirname}/../node_modules/.bin/diff-so-fancy \
    | less --tabs=2 -RFX
  `;

  child_process.execSync(command, {
    input: diffOutput,
    stdio: ['pipe', 'inherit', 'inherit'],
  });
} catch (err) {
  process.exitCode = err.status;
}

fs.unlinkSync(fromTmp);
fs.unlinkSync(toTmp);
